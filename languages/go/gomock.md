# gomock package

[Reference](https://godoc.org/github.com/golang/mock/gomock)

gomock 프레임워크를 이용하여 test code를 작성하는 방법에 대해 정리하고자 한다. [tutorial](https://blog.codecentric.de/en/2017/08/gomock-tutorial/) 을 참고했으며 내용을 번역하고 개인적인 의견을 추가했다. 

## Contents

1. Installation
2. Basic Usage
3. Using gomock with `go:generate'
4. Using argument matchers
5. Asserting call order
6. Specifying mock actions  

### Installation

```bash
go get github.com/golang/mock/gomock  
go get github.com/golang/mock/mockgen  
```

`$GOPATH/bin/` 에 `mockgen` binary 파일이 생성되었다면, 정상적으로 설치된 것이다.

### Basic Usage
gomock의 기본적인 사용은 아래와 같은 순서를 따른다.

- `mockgen`을 이용해 mock을 만들고 싶은 인터페이스에 대한 mock을 생성한다.
- Test에서 `gomock.Controller`의 인스턴스를 생성하고 mock object의 constructor에 넘겨주어, mock object를 만든다.
- mock에서 `EXPECT()`를 call 해서 expectation과 return value를 설정한다. 
- mock controller에서 `Finish()`를 call 해서 mock의 expectation들을 assert한다.

여기부터 한 가지 예제를 가지고 위의 작업을 설명하려고 한다. 파일 구조는 아래와 같다.  

```  
doer   
--- doer.go   
user   
--- user.go   
--- user_test.go  
```

`doer/doer.go` 여기에 우리가 mock을 만들고 싶은 인터페이스가 있고 `Doer` 인터페이스는 `DoSomething()`이라는 메소드를 가지고 있다.

```go

package doer

type Doer interface {  
    DoSomething(int, string) error  
}  
```

`Doer` 의 mock을 만들어서 테스트하고자 하는 메소드가 `user/user.go`에 있다.

```go

package user

import "github.com/sgreben/testing-with-gomock/doer"

type User struct {  
    Doer doer.Doer  
}

func (u *User) Use() error {  
    return u.Doer.DoSomething(123, "Hello GoMock")  
}  
```

이제 `mocks` directory를 만들고 `mockgen`을 실행시켜보자.

```bash 
mkdir -p mocks  
mockgen -destination=mocks/mock_doer.go -package=mocks github.com/sgreben/testing-with-gomock/doer Doer  
```

`mocks` directory를 미리 만들어주지 않으면 error가 발생하기 때문에 반드시 만들어줘야 한다.  
`mockgen` 명령어의 argument들의 의미는 아래와 같다.  

- `-destination=mocks/mock_doer.go`: `mock_doer.go`에 생성된 mock을 넣는다.
- `package=mocks`: 생성된 mock을 `mocks` 패키지에 넣는다.
- `github.com/sgreben/testing-with-gomock/doer`: mock을 생성하고자 하는 패키지
- `Doer`: mock을 생성하고자 하는 대상 인터페이스. `,`로 구분하여 여러 개의 인터페이스를 적으면 각각의 mock을 만들 수 있다. (e.g. `Doer1, Doer2`)

위와 같이 `mockgen`을 실행했다면 파일 구조가 아래와 같이 변경된다.

```  
doer   
--- doer.go   
mocks   
--- mock_doer.go   
user   
--- user.go   
--- user_test.go  
```

생성된 `mock/mock_doer.go` 은 아래와 같이 생겼다.
```go
// Code generated by MockGen. DO NOT EDIT.
// Source: github.com/sgreben/testing-with-gomock/doer (interfaces: Doer)

package mocks

import (
	gomock "github.com/golang/mock/gomock"
)

// MockDoer is a mock of Doer interface
type MockDoer struct {
	ctrl     *gomock.Controller
	recorder *MockDoerMockRecorder
}

// MockDoerMockRecorder is the mock recorder for MockDoer
type MockDoerMockRecorder struct {
	mock *MockDoer
}

// NewMockDoer creates a new mock instance
func NewMockDoer(ctrl *gomock.Controller) *MockDoer {
	mock := &MockDoer{ctrl: ctrl}
	mock.recorder = &MockDoerMockRecorder{mock}
	return mock
}

// EXPECT returns an object that allows the caller to indicate expected use
func (_m *MockDoer) EXPECT() *MockDoerMockRecorder {
	return _m.recorder
}

// DoSomething mocks base method
func (_m *MockDoer) DoSomething(_param0 int, _param1 string) error {
	ret := _m.ctrl.Call(_m, "DoSomething", _param0, _param1)
	ret0, _ := ret[0].(error)
	return ret0
}

// DoSomething indicates an expected call of DoSomething
func (_mr *MockDoerMockRecorder) DoSomething(arg0, arg1 interface{}) *gomock.Call {
	return _mr.mock.ctrl.RecordCall(_mr.mock, "DoSomething", arg0, arg1)
}  
```

다음으로 실제 테스트에서 mock을 어떻게 사용하는지 알아보자.

`user/user_test.go`

```go
package user_test

import (
  "github.com/sgreben/testing-with-gomock/mocks"
  "github.com/sgreben/testing-with-gomock/user"
)

func TestUse(t *testing.T) {
    mockCtrl := gomock.NewController(t)
    defer mockCtrl.Finish()

    mockDoer := mocks.NewMockDoer(mockCtrl)
    testUser := &user.User{Doer:mockDoer}

    // Expect Do to be called once with 123 and "Hello GoMock" as parameters, and return nil from the mocked call.
    mockDoer.EXPECT().DoSomething(123, "Hello GoMock").Return(nil).Times(1)

    testUser.Use()
}
```

**mock controller** constructor에 `*testing.T` 타입의 `t`를 pass해서 mock controller를 얻는다. 
이것으로 `Doer` 인터페이스의 mock object를 생성할 수 있다. 
만약 `123`, `Hello Gomock` 두 개의 argument로 `nil`을 return하는 `mockDoer`의 `DoSomething` 메소드를 한 번 호출한다고 하자.

`mockDoer.EXPECT().DoSomething(123, "Hello GoMock").Return(nil).Times(1)`

그렇다면 위와 같이 코드를 쓸 수 있다.
